name: CI

on:
  push:
    branches: [master, dev]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE-*'
      - '.editorconfig'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/CODEOWNERS'
  pull_request:
    branches: [master, dev]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE-*'
      - '.editorconfig'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/CODEOWNERS'

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  # ============================================
  # TIER 1: Auto for Owner/Collaborator/Member/Contributor
  # ============================================
  ci:
    name: CI
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'push' ||
      contains(fromJSON('["OWNER", "COLLABORATOR", "MEMBER", "CONTRIBUTOR"]'), github.event.pull_request.author_association)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --check
      - run: cargo clippy --all-targets
      - run: cargo test

  msrv:
    name: MSRV (1.83.0)
    runs-on: ubuntu-latest
    needs: ci
    if: >-
      github.event_name == 'push' ||
      contains(fromJSON('["OWNER", "COLLABORATOR", "MEMBER"]'), github.event.pull_request.author_association)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@1.83.0
      - uses: Swatinem/rust-cache@v2
      - run: cargo check

  # ============================================
  # TIER 2: Newcomers (first-timers) need approval
  # ============================================
  approve-newcomer:
    name: Approve CI
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'pull_request' &&
      contains(fromJSON('["FIRST_TIMER", "FIRST_TIME_CONTRIBUTOR", "NONE"]'), github.event.pull_request.author_association)
    environment: ci-approval
    steps:
      - run: echo "Newcomer CI approved"

  ci-newcomer:
    name: CI (Newcomer)
    runs-on: ubuntu-latest
    needs: approve-newcomer
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --check
      - run: cargo clippy --all-targets
      - run: cargo test
